{"id":67362,"name":"PubSub Events Promote to IB","userId":87717,"accountId":62974,"createdDate":"2021-11-30T13:45:52Z","steps":[{"id":591859,"onSuccess":["preparePubSubEventPayload"],"onFailure":["end"],"name":"checkOrg","type":"filter","properties":{"body":"const myCompanyId = steps.getOrgForCurrentUser.response.body.id;\nconst instanceCompanyId = steps.getFullAccount.response.body.companyId;\n\nif (instanceCompanyId === myCompanyId) {\n  done(false);\n} else {\n  done(true);\n}"}},{"id":591818,"onSuccess":["checkUCSTrigger"],"onFailure":["end"],"name":"checkStatus","type":"filter","properties":{"body":"  if (trigger.response.code === 200) {\n    done(true);\n  } else {\n    done(false);\n  }"}},{"id":591825,"onSuccess":["extractUserId"],"onFailure":["end"],"name":"checkUCSTrigger","type":"filter","properties":{"body":"const referer = trigger.request.headers.referer;\nconst catalogItemId = trigger.request.body.key;\n\nif(referer !== undefined && referer.includes(\"catalog/explore\") && referer.includes(catalogItemId)) {\n  done(true);\n} else {\n  done(false);\n}"}},{"id":591889,"onSuccess":[],"onFailure":[],"name":"end","type":"script","properties":{"body":"done({ success: false });"}},{"id":591830,"onSuccess":["getFullUser"],"onFailure":[],"name":"extractUserId","type":"script","properties":{"body":"let id = '';\nid = trigger && trigger.request && trigger.request.headers && trigger.request.headers[\"x-consumer-custom-id\"];\nid = id.split(\":\")[2];\ndone(id);"}},{"id":591841,"onSuccess":["getOrgForCurrentUser"],"onFailure":[],"name":"getFullAccount","type":"request","properties":{"api":"/accounts/${steps.getFullUser.response.body.account.id}","method":"GET"}},{"id":591835,"onSuccess":["getFullAccount"],"onFailure":["end"],"name":"getFullUser","type":"request","properties":{"api":"/users/${steps.extractUserId}","method":"GET"}},{"id":591846,"onSuccess":["getUserOrgName"],"onFailure":[],"name":"getOrgForCurrentUser","type":"request","properties":{"api":"/organizations/me","method":"GET"}},{"id":591852,"onSuccess":["checkOrg"],"onFailure":["end"],"name":"getUserOrgName","type":"request","properties":{"api":"/customers/organizations/${steps.getFullAccount.response.body.companyId}","method":"GET"}},{"id":591868,"onSuccess":["preparePubSubRequest"],"onFailure":[],"name":"preparePubSubEventPayload","type":"script","properties":{"body":"const { environment } = config;\nconst orgId = steps.getFullAccount.response.body.externalId.split('|',1)[0];\nlet payload = {\n  \"username\" : steps.getFullUser.response.body.externalId,\n  \"org_id\" : orgId,\n  \"org_name\" : steps.getUserOrgName.response.body.name,\n  \"connector_id\": trigger.response.body.id,\n  \"connector_name\": trigger.response.body.name,\n  \"catalogitem_id\": trigger.request.body.key,\n  \"catalogitem_name\": trigger.request.body.name,\n  \"ce_environment\": environment,\n  \"central_environment\": trigger.request.headers.origin,\n  \"id\": orgId\n}\nlet data = {\n  \"body\" : {\n    \"event\" : `apic.ucs.catalogitem.promote.ib`,\n    \"data\" : payload\n  }\n};\ndone(data);"}},{"id":591877,"onSuccess":["sendPubSubEvent"],"onFailure":[],"name":"preparePubSubRequest","type":"script","properties":{"body":"\nlet APISig = '';\n\nlet data = steps.preparePubSubEventPayload.body;\nAPISig = CE.hmacSha256Base64(config.pubSubSecret, JSON.stringify(data));\n\nconst options = {\n  url: config.pubSubURL,\n  json: data,\n  headers: {\n    APIKey: config.pubSubAPIKey,\n    APISig\n  }\n}\n\ndone(options);"}},{"id":591883,"onSuccess":[],"onFailure":["end"],"name":"sendPubSubEvent","type":"httpRequest","properties":{"url":"${steps.preparePubSubRequest.url}","method":"POST","headers":"${steps.preparePubSubRequest.headers}","body":"${steps.preparePubSubRequest.json}"}}],"triggers":[{"id":54592,"onSuccess":["checkStatus"],"onFailure":[],"type":"request","async":true,"active":true,"name":"trigger","properties":{"api":"/elements","method":"POST","level":"customer"}}],"engine":"v3","active":true,"debugLoggingEnabled":false,"singleThreaded":false,"configuration":[{"id":103925,"key":"environment","name":"environment","type":"value","required":true},{"id":103929,"key":"pubSubAPIKey","name":"pubSubAPIKey","type":"value","required":true},{"id":103931,"key":"pubSubSecret","name":"pubSubSecret","type":"value","required":true},{"id":103933,"key":"pubSubURL","name":"pubSubURL","type":"value","required":true}]}