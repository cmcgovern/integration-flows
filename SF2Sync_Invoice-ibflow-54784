{"id":54784,"name":"SF2Sync_Invoice","debugLoggingExpires":"2021-06-12T02:04:02Z","userId":55170,"accountId":42187,"createdDate":"2021-06-11T18:04:02Z","steps":[{"id":540418,"onSuccess":["getClient"],"onFailure":["logNotCloseWon"],"description":"Check if the opp event is a change to Closed Won state.","name":"checkOppStatus","type":"filter","properties":{"body":"if(trigger.body.message.raw.opportunities[0].StageName === 'Closed Won') {\n  done(true);\n} else {\n  console.log('Not a Closed-Won Opportunity');\n  done(false);\n}"}},{"id":540419,"onSuccess":["setupTransfer"],"onFailure":[],"name":"generateInvoice","type":"httpRequest","properties":{"method":"POST","headers":"${steps.invoiceRequest.headers}","body":"${steps.invoiceRequest.body}","url":"${steps.invoiceRequest.url}"}},{"id":540420,"onSuccess":["getProducts"],"onFailure":[],"description":"Get SF Account Info to populate Client fields for invoice.","name":"getClient","type":"elementRequest","properties":{"method":"GET","elementInstanceId":"${config.salesforce}","api":"/SFAccountMapping/${trigger.body.message.raw.opportunities[0].AccountId}"}},{"id":540421,"onSuccess":["invoiceRequest"],"onFailure":[],"name":"getProducts","type":"elementRequest","properties":{"method":"GET","elementInstanceId":"${config.salesforce}","api":"/SFProductMapping?where=OpportunityId='${trigger.body.message.raw.opportunities[0].Id}'"}},{"id":540422,"onSuccess":["generateInvoice"],"onFailure":[],"name":"invoiceRequest","type":"script","properties":{"body":"let headers = {\n  \"Authorization\": \"zliP72dq3EkSdwpLVCRA8rDysw2rP2CjgH7YPxjFQiaoR10BRZ08jT1y36nJymQT\",\n  \"Content-Type\": \"application/json\"\n}\n\nlet url = 'https://api.spaceinvoices.com/v1/organizations/60747713ac34d603c67d3fb7/documents';\n\nlet body = {};\nbody._documentClient=steps.getClient.response.body;\nbody._documentItems=steps.getProducts.response.body;\n\ndone({\n  body:body,\n  url:url,\n  headers:headers\n})"}},{"id":540423,"onSuccess":[],"onFailure":[],"description":"This step will log a not-won status in the console.","name":"logNotCloseWon","type":"script","properties":{"body":"console.log('Not Closed/Won Opportunity');"}},{"id":540424,"onSuccess":[],"onFailure":[],"name":"sendPDF2Sync","type":"elementRequestStream","properties":{"uploadMethod":"POST","uploadApi":"${steps.setupTransfer.syncURL}","downloadApi":"${steps.setupTransfer.invoiceURL}","uploadElementInstanceId":"${config.syncplicity}","downloadElementInstanceId":"${config.spaceinvoice}","downloadMethod":"GET"}},{"id":540425,"onSuccess":["sendPDF2Sync"],"onFailure":[],"name":"setupTransfer","type":"script","properties":{"body":"//set invoice service variables\nlet invoiceURL = '/documents/'+steps.generateInvoice.response.body.id;\nlet headers = {\n  \"Authorization\": \"zliP72dq3EkSdwpLVCRA8rDysw2rP2CjgH7YPxjFQiaoR10BRZ08jT1y36nJymQT\"\n}\n\n//set sync variables\nlet syncURL = '/files?path=/Invoices'+'/Invoice-'+steps.generateInvoice.response.body.number+'.pdf'\n\ndone({\n  invoiceURL:invoiceURL,\n  syncURL:syncURL,\n  headers:headers\n});"}}],"triggers":[{"id":47292,"onSuccess":["checkOppStatus"],"onFailure":[],"type":"event","async":true,"active":true,"name":"trigger","properties":{"elementInstanceId":"${config.salesforce}"}}],"engine":"v3","active":true,"debugLoggingEnabled":false,"singleThreaded":false,"configuration":[{"id":94144,"key":"salesforce","name":"salesforce","type":"elementInstance","description":"Salesforce connector instance.","required":true},{"id":94145,"key":"spaceinvoice","name":"spaceinvoice","type":"elementInstance","description":"Space Invoice Connector Instance","required":true},{"id":94149,"key":"syncplicity","name":"syncplicity","type":"elementInstance","description":"Syncplicity Connector Instance","required":true}]}